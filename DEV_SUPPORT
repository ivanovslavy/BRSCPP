# ğŸ“˜ Merchant Integration Flow - A Real-World Example

This guide details the step-by-step process for a merchant (Ivan's Digital Shop) to integrate the BRSCPP protocol for crypto payments.

## Scenario: Online Store Accepting Crypto Payments

**Merchant Goal:** Ivan wants to accept crypto payments on his online store for digital products without handling private keys or custody.

---

## STEP 1: Registration (One-Time Setup)

Ivan registers to link his wallet and obtain API access.

**Registration URL:** `https://pp.slavy.space/register`

### Actions:

1.  **Connect Wallet:** Ivan connects his MetaMask wallet (the non-custodial destination for received funds).
    * **Wallet Address Example:** `0x742d35Cc6634C0532925a3b844Bc454e4438f44e`
2.  **Form Submission:** Fills out the necessary details (Email: `ivan@myshop.com`, Company Name: Ivan's Digital Shop) and passes the Cloudflare Turnstile CAPTCHA.

### API Key Generation:

Upon successful registration, Ivan receives a unique API Key (shown only once):
`pk_test_a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6q7r8s9t0u1v2w3x4y5z6`

**Security Note:** Ivan saves the key securely in his backend's environment configuration:

```dotenv
# Ivan's backend .env file
BRSCPP_API_KEY=pk_test_a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6q7r8s9t0u1v2w3x4y5z6

STEP 2: Backend Integration (Ivan's Server - Node.js/Express)

Ivan's server handles the creation of the payment request via the BRSCPP API.
JavaScript

// server.js
const express = require('express');
const axios = require('axios');
require('dotenv').config();

const app = express();
app.use(express.json());

const BRSCPP_API_URL = '[https://api.pp.slavy.space](https://api.pp.slavy.space)';
const BRSCPP_API_KEY = process.env.BRSCPP_API_KEY;

// Ivan's checkout endpoint
app.post('/checkout', async (req, res) => {
  const { productId, customerEmail } = req.body;
  
  // Ivan fetches product info from his DB
  const product = await getProductFromDatabase(productId);
  // Example: product = { id: 'PROD-123', name: 'Premium Course', price: 99.99 }
  
  try {
    // Ivan creates payment request via BRSCPP API
    const response = await axios.post(
      `${BRSCPP_API_URL}/api/merchant/payment-request`,
      {
        orderId: `ORDER-${Date.now()}-${productId}`,
        amountUsd: product.price.toString(),
        description: `Payment for ${product.name}`,
        customerEmail: customerEmail
      },
      {
        headers: {
          'Authorization': `Bearer ${BRSCPP_API_KEY}`,
          'Content-Type': 'application/json'
        }
      }
    );
    
    const paymentRequest = response.data.paymentRequest;
    
    // Ivan saves payment request in his DB
    await savePaymentToDatabase({
      orderId: paymentRequest.orderId,
      productId: productId,
      amount: paymentRequest.amountUsd,
      status: 'pending',
      paymentUrl: paymentRequest.paymentUrl,
      brscppPaymentId: paymentRequest.id
    });
    
    // Ivan returns payment URL to his frontend
    res.json({
      success: true,
      paymentUrl: paymentRequest.paymentUrl,
      orderId: paymentRequest.orderId
    });
    
  } catch (error) {
    console.error('BRSCPP payment creation failed:', error);
    res.status(500).json({ error: 'Payment creation failed' });
  }
});

app.listen(3000);

STEP 3: Frontend Integration (Ivan's Website - React)

Ivan's checkout page handles the redirection to the BRSCPP payment gateway.
JavaScript

// CheckoutPage.jsx
function CheckoutPage({ product }) {
  const [loading, setLoading] = useState(false);
  
  const handleCryptoPayment = async () => {
    setLoading(true);
    
    try {
      // Ivan's backend creates payment request
      const response = await fetch('[https://ivanshop.com/checkout](https://ivanshop.com/checkout)', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          productId: product.id,
          customerEmail: 'customer@example.com'
        })
      });
      
      const data = await response.json();
      
      // Redirect customer to BRSCPP payment page
      window.location.href = data.paymentUrl;
      // Example: [https://app.pp.slavy.space/checkout/ORDER-1732456789-PROD-123](https://app.pp.slavy.space/checkout/ORDER-1732456789-PROD-123)
      
    } catch (error) {
      alert('Payment failed');
    } finally {
      setLoading(false);
    }
  };
  
  return (
    <div>
      <h2>{product.name}</h2>
      <p>Price: ${product.price}</p>
      
      <button onClick={handleCryptoPayment} disabled={loading}>
        {loading ? 'Redirecting...' : 'Pay with Crypto'}
      </button>
    </div>
  );
}

STEP 4: Customer Payment Flow

The customer completes the transaction on the BRSCPP gateway.

Transaction Flow:

    Redirect to BRSCPP: https://app.pp.slavy.space/checkout/ORDER-1732456789-PROD-123

    Price Quote: Customer clicks "Get Price Quote."

        Gateway calls Chainlink Oracle (e.g., ETH/USD: $2,800).

        Calculates crypto amount: $99.99 / $2,800 = 0.0357 ETH.

        Locks quote for 60 seconds.

    Customer Sends: Customer approves MetaMask prompt ("Send 0.0357 ETH").

Smart Contract Settlement:
Ğ¤Ñ€Ğ°Ğ³Ğ¼ĞµĞ½Ñ‚ Ğ¾Ñ‚ ĞºĞ¾Ğ´

graph TD
    A[Customer Wallet] -->|0.0357 ETH| B(Gateway Contract);
    B -->|99.5% (0.0355 ETH)| C[Ivan's Wallet 0x742d35Cc...];
    B -->|0.5% (0.0002 ETH)| D[Fee Collector];

STEP 5: Webhook Notification (Real-time Order Fulfillment)

BRSCPP API automatically sends a secure webhook to Ivan's server upon successful on-chain settlement.

Webhook Setup (One-Time)

Ivan registers his webhook URL:
Bash

curl -X POST [https://api.pp.slavy.space/api/merchant/webhook](https://api.pp.slavy.space/api/merchant/webhook) \
  -H "Authorization: Bearer pk_test_a1b2c3d4..." \
  -H "Content-Type: application/json" \
  -d '{
    "webhookUrl": "[https://ivanshop.com/webhook/brscpp](https://ivanshop.com/webhook/brscpp)",
    "webhookSecret": "my_secret_key_12345"
  }'

Ivan's Webhook Handler

Ivan verifies the signature and updates the order status.
JavaScript

// server.js - webhook endpoint
const crypto = require('crypto');

app.post('/webhook/brscpp', express.json(), async (req, res) => {
  // Verify signature
  const signature = req.headers['x-webhook-signature'];
  const payload = JSON.stringify(req.body);
  
  const expectedSignature = crypto
    .createHmac('sha256', 'my_secret_key_12345')
    .update(payload)
    .digest('hex');
  
  if (signature !== expectedSignature) {
    return res.status(401).send('Invalid signature');
  }
  
  const { event, payment } = req.body;
  
  if (event === 'payment.completed') {
    console.log('Payment received!');
    // ... logging payment details ...
    
    // Ivan updates his DB and delivers the product
    await updateOrderStatus(payment.orderId, 'paid');
    await deliverProduct(payment.orderId);
    await sendConfirmationEmail(payment.orderId);
  }
  
  res.status(200).send('OK');
});

Webhook Payload Example:

JSON

{
  "event": "payment.completed",
  "payment": {
    "id": "uuid-123",
    "orderId": "ORDER-1732456789-PROD-123",
    "merchantAddress": "0x742d35Cc6634C0532925a3b844Bc454e4438f44e",
    "usdAmount": 99.99,
    "txHash": "0xabc123def456...",
    "timestamp": "2025-11-24T15:30:00Z"
  }
}

ALTERNATIVE: Polling Method (Without Webhooks)

If webhooks are not feasible, Ivan can poll the API for status:
JavaScript

// Ivan's backend polls for payment status
async function checkPaymentStatus(orderId) {
  const response = await axios.get(
    `https://api.pp.slavy.space/api/customer/payment/${orderId}/status`
  );
  
  const status = response.data.status;
  
  if (status === 'completed') {
    console.log('Payment completed!');
    await deliverProduct(orderId);
    return true;
  }
  return false;
}

REAL WORLD FLOW SUMMARY

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Ivan's Store   â”‚
â”‚   (Frontend)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ 1. Customer clicks "Pay with Crypto"
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Ivan's Backend â”‚
â”‚  POST /checkout â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ 2. Creates payment request via BRSCPP API
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    BRSCPP API   â”‚
â”‚api.pp.slavy.spaceâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ 3. Returns payment URL
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ BRSCPP Payment  â”‚
â”‚      Page       â”‚
â”‚app.pp.slavy.spaceâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ 4. Customer connects wallet
         â”‚ 5. Locks price quote (60s)
         â”‚ 6. Sends payment
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚Smart Contract   â”‚
â”‚   on Sepolia    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ 7. Splits payment: 99.5% â†’ Ivan's Wallet
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Ivan's Wallet   â”‚
â”‚ 0x742d35Cc...   â”‚
â”‚ +0.0355 ETH     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ 8. Webhook notification
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Ivan's Backend  â”‚
â”‚ /webhook/brscpp â”‚
â”‚ - Updates order â”‚
â”‚ - Delivers productâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
